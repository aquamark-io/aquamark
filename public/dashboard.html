<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard | Aquamark.io</title>
  <script>
    var o_options = {
      domain: 'aquamark.outseta.com',
      load: 'nocode'
    };
  </script>
  <script src="https://cdn.outseta.com/outseta.min.js" data-options="o_options"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f9ff;
      margin: 0;
      padding: 2rem;
    }
    .container {
      background: white;
      max-width: 800px;
      margin: auto;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }
    .usage {
      margin-top: 2rem;
    }
    .bar {
      height: 18px;
      border-radius: 8px;
      background: #d1d5db;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      background: #3b82f6;
      transition: width 0.4s;
    }
    .warning {
      color: #b91c1c;
      margin-top: 8px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Welcome to your Dashboard</h1>
    <p id="userName"></p>
    <div class="usage">
      <h3>Monthly Usage</h3>
      <div id="usageText">Loading usage...</div>
      <div class="bar" style="margin-top: 6px;">
        <div id="barFill" class="bar-fill" style="width: 0%"></div>
      </div>
      <div id="warning" class="warning"></div>
      <p style="margin-top: 10px; font-size: 0.9rem; color: #555">Usage resets on the 1st of every month.</p>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      'https://dvzmnikrvkvgragzhrof.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2em1uaWtydmt2Z3JhZ3pocm9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5Njg5NzUsImV4cCI6MjA1OTU0NDk3NX0.FaHsjIRNlgf6YWbe5foz0kJFtCO4FuVFo7KVcfhKPEk'
    );

    function getPlanLimit(planName, isTrial) {
      if (isTrial) return 100;
      switch (planName.toLowerCase()) {
        case 'riding solo': return 1000;
        case 'small teams': return 5000;
        case 'iso shops':
        case 'iso unlimited': return Infinity;
        default: return 100;
      }
    }

    async function loadUsage() {
      const user = await waitForOutsetaUser();
      if (!user?.Email) return;

      const name = user.FirstName || 'User';
      const email = user.Email;
      const planName = user.Subscription?.Plan?.Name || '';
      const isTrial = user.Account?.IsTrialing;

      document.getElementById('userName').textContent = `Logged in as ${name} (${email})`;

      const now = new Date();
      const month = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      const { data, error } = await supabase
        .from('usage')
        .select('*')
        .eq('user_email', email)
        .eq('month', month)
        .single();

      const pagesUsed = data?.pages_used || 0;
      const limit = getPlanLimit(planName, isTrial);

      let usageText = '';
      let barPercent = 0;
      let warning = '';

      if (limit === Infinity) {
        usageText = `${pagesUsed} pages used (Unlimited)`;
        document.getElementById('barFill').style.background = '#10b981';
        barPercent = 100;
      } else {
        usageText = `${pagesUsed} / ${limit} pages used`;
        barPercent = Math.min(100, Math.round((pagesUsed / limit) * 100));
        if (pagesUsed >= limit) {
          warning = 'You have reached your monthly limit.';
        } else if (barPercent > 80) {
          warning = 'You are nearing your limit.';
        }
      }

      document.getElementById('usageText').textContent = usageText;
      document.getElementById('barFill').style.width = barPercent + '%';
      document.getElementById('warning').textContent = warning;
    }

    function waitForOutsetaUser() {
      return new Promise((resolve) => {
        let attempts = 0;
        const interval = setInterval(() => {
          const user = Outseta?.nocode?.user;
          if (user) {
            clearInterval(interval);
            resolve(user);
          }
          if (++attempts > 60) {
            clearInterval(interval);
            resolve(null);
          }
        }, 100);
      });
    }

    loadUsage();
  </script>
</body>
</html>
