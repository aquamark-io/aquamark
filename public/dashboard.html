<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aquamark - Watermark Upload Preview</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 32px;
    }
    #watermarkOverlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-repeat: repeat;
      background-size: 150px;
      opacity: 0.1;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <h2>Watermark Your Files</h2>

  <!-- Upload Section -->
  <div style="display: flex; gap: 40px; flex-wrap: wrap; align-items: flex-start;">
    <div style="flex: 1; min-width: 280px;">
      <label style="font-weight: 600;">Upload your watermark logo (PNG or JPG):</label><br />
      <input type="file" id="logoInput" accept="image/png, image/jpeg" />
      <button id="changeLogoButton" style="margin-top: 8px;">Change Logo</button>

      <div id="logoPreviewContainer" style="display:none; margin-top: 16px;">
        <p style="font-weight: 600;">Your uploaded logo:</p>
        <img id="logoPreview" src="" alt="Your Logo" style="max-width: 300px; border: 1px solid #eee; padding: 8px;" />
      </div>
    </div>

    <!-- Sample Preview Section -->
    <div style="flex: 1; min-width: 300px;">
      <p style="font-weight: 600; margin-bottom: 8px;">See a sample:</p>
      <div style="position: relative; width: 100%; max-width: 600px; border: 1px solid #ccc;">
        <img id="statementImage" src="/statement.jpg" alt="Sample Statement" style="width: 100%; display: block;" />
        <div id="watermarkOverlay"></div>
      </div>
    </div>
  </div>

  <!-- Supabase + Upload + Overlay Handler -->
  <script type="module">
    import { createClient } from "https://cdn.skypack.dev/@supabase/supabase-js";

    const supabase = createClient(
      "https://dvzmnikrvkvgragzhrof.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2em1uaWtydmt2Z3JhZ3pocm9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5Njg5NzUsImV4cCI6MjA1OTU0NDk3NX0.FaHsjIRNlgf6YWbe5foz0kJFtCO4FuVFo7KVcfhKPEk"
    );

    const logoInput = document.getElementById("logoInput");
    const changeLogoButton = document.getElementById("changeLogoButton");
    const previewContainer = document.getElementById("logoPreviewContainer");
    const previewImage = document.getElementById("logoPreview");
    const overlay = document.getElementById("watermarkOverlay");

    // Load from localStorage on page load
    const savedLogo = localStorage.getItem("aquamark_logo_url");
    if (savedLogo) {
      previewImage.src = savedLogo;
      previewContainer.style.display = "block";
      overlay.style.backgroundImage = `url('${savedLogo}')`;
    }

    changeLogoButton.addEventListener("click", async () => {
      const file = logoInput.files[0];
      if (!file) return alert("Please choose a logo first.");

      const extension = file.name.split(".").pop().toLowerCase();
      const filePath = `logo.${extension}`;

      await supabase.storage.from("logos").remove([filePath]);

      const { error: uploadError } = await supabase.storage
        .from("logos")
        .upload(filePath, file, {
          upsert: true,
          contentType: file.type,
        });

      if (uploadError) {
        console.error("Upload error:", uploadError.message);
        alert("Upload failed: " + uploadError.message);
        return;
      }

      const { data: publicData, error: publicUrlError } = supabase.storage
        .from("logos")
        .getPublicUrl(filePath);

      if (publicUrlError || !publicData?.publicUrl) {
        console.error("Public URL error:", publicUrlError);
        alert("Failed to get public URL.");
        return;
      }

      const url = publicData.publicUrl;

      localStorage.setItem("aquamark_logo_url", url);
      previewImage.src = url;
      previewContainer.style.display = "block";
      overlay.style.backgroundImage = `url('${url}')`;

      console.log("New logo uploaded and applied.");
    });
  </script>
</body>
</html>
