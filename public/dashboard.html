<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Aquamark Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="icon" href="/logo-icon-black-blue.jpg" type="image/jpg">
    <style>
        :root {
            --primary-color: #467EFF;
            --primary-light: #f8fafc;
            --primary-dark: #1d4ed8;
            --accent-color: #467EFF;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --text-primary: #1a1a1a;
            --text-secondary: #64748b;
            --bg-color: #ffffff;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .aqua-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--primary-light);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .aqua-logo {
            height: 32px;
        }

        .aqua-nav {
            display: flex;
            align-items: center;
        }

        .aqua-nav a {
            margin-left: 2rem;
            text-decoration: none;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
            position: relative;
        }

        .aqua-nav a:hover {
            color: var(--accent-color);
        }

        .aqua-nav a.active {
            color: var(--accent-color);
        }

        .aqua-nav a.active:after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            height: 3px;
            width: 100%;
            background: #467EFF;
            border-radius: 3px;
        }

        .action-buttons a {
            text-decoration: none;
        }

        .btn-demo {
            background: linear-gradient(90deg, #a855f7, #ec4899);
            color: white;
            border: none;
        }

        .btn-demo:hover {
            opacity: 0.9;
        }

        /* Main Content */
        .aqua-panel {
            max-width: 1400px;
            width: 95%;
            margin: 2rem auto;
            flex: 1;
        }

        h1.greeting {
            font-size: 2rem;
            margin-bottom: 2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Main Layout */
        .aqua-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
        }

        /* Cards */
        .aqua-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            height: 100%;
        }

        .aqua-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-header h2::before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: var(--accent-color);
            border-radius: 50%;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Action Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            padding: 0 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-accent {
            background: #467EFF;
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-watermark {
            background: #467EFF;
            color: white;
        }

        .btn-watermark:hover {
            background: #95cbea;
        }

        .btn-success {
            background: white;
            color: #467EFF;
            border: 2px solid #467EFF;
        }

        .btn-accent:hover {
            background: #1d4ed8;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .btn-outline:hover {
            background: var(--primary-light);
            border-color: var(--primary-color);
        }

        .btn-black {
            background: #000000;
            color: #ffffff;
        }

        .btn-black:hover {
            background: #333333;
        }

        /* Announcement Banner - Clean & Minimal with Urgency */
        .announcement-banner {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            color: var(--text-primary);
            border-radius: var(--radius);
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .announcement-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #467EFF, #1d4ed8);
        }

        .announcement-content {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            flex: 1;
        }

        .announcement-icon {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #467EFF;
            font-size: 1.75rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .announcement-text h3 {
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            letter-spacing: -0.025em;
        }

        .announcement-text p {
            color: var(--text-secondary);
            line-height: 1.5;
            font-size: 1rem;
        }

        .announcement-text .highlight {
            color: #10b981;
            font-weight: 600;
        }

        .announcement-text .disclaimer {
            font-size: 0.875rem;
            color: #94a3b8;
            font-style: italic;
            margin-top: 0.25rem;
        }

        /* Usage Stats */
        .usage-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .usage-label {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .usage-value {
            font-weight: 600;
        }

        .progress-bar {
            background: #f3f4f6;
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-fill {
            background: #467EFF;
            height: 100%;
            width: 0%;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 2rem;
        }

        /* Footer */
        .aqua-footer {
            background: var(--primary-light);
            padding: 1.5rem 2rem;
            margin-top: 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-logo {
            height: 24px;
        }

        .footer-nav {
            display: flex;
            gap: 2rem;
        }

        .footer-nav a {
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .footer-nav a:hover {
            color: var(--accent-color);
        }

        .footer-copyright {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .aqua-layout {
                grid-template-columns: 1fr;
            }

            .announcement-banner {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                padding: 1.5rem;
            }

            .announcement-text h3 {
                font-size: 1.25rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .aqua-footer {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .footer-nav {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>

    <!-- Outseta integration -->
    <script>
        var o_options = {
            domain: 'aquamark.outseta.com',
            load: 'auth,customForm,emailList,leadCapture,nocode,profile,support'
        };
    </script>
    <script src="https://cdn.outseta.com/outseta.min.js" data-options="o_options"></script>
</head>

<body>
    <header class="aqua-header">
        <img src="/logo-full-black-blue.png" alt="Aquamark Logo" class="aqua-logo">
        <nav class="aqua-nav">
            <a href="/dashboard.html" class="active">Dashboard</a>
            <a href="/watermark.html" id="watermarkLink">Watermark</a>
            <a href="https://www.aquamark.io/login.html">Log Out</a>
        </nav>
    </header>

    <main class="aqua-panel">
        <h1 class="greeting">My Dashboard</h1>

        <!-- Updated Announcement Banner -->
        <div class="announcement-banner">
            <div class="announcement-content">
                <div class="announcement-icon">
                    ⚠
                </div>
                <div class="announcement-text">
                    <h3>Join the Fight Against Backdooring</h3>
                    <p>
                        One stolen deal is costing brokers <span class="highlight">$4,000*</span> in commission. 
                    </p>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <a href="https://aquamark.outseta.com/profile?tab=planChange#o-authenticated" class="btn" style="background-color: #10b981; color: white;">Subscribe</a>
            <a href="/watermark.html" id="startWatermarkBtn" class="btn btn-watermark">Watermark</a>
            <a href="https://www.aquamark.io/api" target="_blank" class="btn btn-black">API Docs</a>
        </div>

        <!-- Main Layout -->
        <div class="aqua-layout">
            <!-- Profile Card -->
            <div class="aqua-card">
                <div class="card-header">
                    <h2>My Profile</h2>
                </div>
                <div class="card-body">
                    <div data-o-profile="1" data-mode="embed"></div>
                </div>
            </div>

            <!-- Usage Card -->
            <div class="aqua-card">
                <div class="card-header">
                    <h2>Your Usage</h2>
                </div>
                <div class="card-body" id="usage-stats">
                    <p>Loading your usage data...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="aqua-footer">
        <img src="/logo-full-black-blue.png" alt="Aquamark Logo" class="footer-logo">
        <div class="footer-nav">
            <a href="https://www.aquamark.io/terms.html">Terms of Service</a>
            <a href="https://www.aquamark.io/privacy.html">Privacy Policy</a>
            <a href="mailto:hey@aquamark.io">Contact Us</a>
        </div>
        <div class="footer-copyright">© 2025 Aquamark. All rights reserved.</div>
    </footer>

    <script>
        // Configuration - YOUR SECURE BACKEND
        const API_BASE_URL = 'https://aquamark-backend.onrender.com';
        
        // Global variables
        let currentUser = null;
        let userToken = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            preserveUrlParameters();
        });

        // Initialize the page
        async function initializePage() {
            try {
                // Get user from Outseta
                currentUser = await Outseta.getUser();
                if (!currentUser) {
                    window.location.href = '/login.html';
                    return;
                }

                console.log("User loaded:", currentUser.Email);

                // Get auth token for API calls
                userToken = await getAuthToken();
                
                // Load usage data
                await loadUsageData();
                
                // Set up Outseta event listeners for plan changes
                setupOutsetaEventListeners();
                
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('usage-stats').innerHTML = '<p>Error loading dashboard. Please refresh the page.</p>';
            }
        }

        // Replace your loadUsageData function with this version that gets referral code from Outseta profile
        async function loadUsageData() {
            try {
                if (!userToken) {
                    document.getElementById('usage-stats').innerHTML = '<p>Unable to load usage data - no auth token</p>';
                    return;
                }
                
// Temporary tracking issue notice
document.getElementById('usage-stats').innerHTML = `
    <div style="background: #fff8e1; border: 1px solid #fde68a; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; color: #92400e;">
        <strong>📣 Usage Tracking Delay</strong><br>
        All watermarking functionality continues to work normally. Our data provider is experiencing temporary issues that are affecting usage tracking. The issue is being resolved on their end and your usage data will be restored shortly.
    </div>
`;

                // Get referral code from Outseta profile - JUST LIKE THE OLD WORKING CODE
                let referralCode = null;
                try {
                    const profile = await Outseta.getUser();
                    if (profile && profile.ref_code) {
                        referralCode = profile.ref_code;
                        console.log('🎯 Got referral code from Outseta profile:', referralCode);
                    }
                } catch (error) {
                    console.error('Error getting Outseta profile:', error);
                }

                // Send to your existing /api/usage endpoint
                const requestBody = {};
                if (referralCode) {
                    requestBody.referralCode = referralCode;
                    console.log('✅ Sending referral code to backend:', referralCode);
                }

                const response = await fetch(`${API_BASE_URL}/api/usage`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${userToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (response.ok) {
                    const userData = await response.json();
                    displayUsageData(userData);
                } else {
                    const error = await response.json();
                    document.getElementById('usage-stats').innerHTML = `<p>Error loading usage: ${error.error}</p>`;
                }
            } catch (error) {
                console.error('Error loading usage data:', error);
                document.getElementById('usage-stats').innerHTML = '<p>Error loading usage data. Please refresh the page.</p>';
            }
        }

        // Preserve URL parameters for navigation
        function preserveUrlParameters() {
            const urlParams = window.location.search;
            const hashParams = window.location.hash;

            const pathsToUpdate = ["/watermark.html", "/dashboard.html"];

            document.querySelectorAll("a[href]").forEach(link => {
                const href = link.getAttribute("href");
                if (href && pathsToUpdate.some(path => href.startsWith(path))) {
                    const cleanHref = href.split('?')[0].split('#')[0];
                    link.href = cleanHref + urlParams + hashParams;
                }
            });
        }

        // Get auth token for API calls
        async function getAuthToken() {
            try {
                const token = await Outseta.getAccessToken();
                return token;
            } catch (error) {
                console.error('Error getting auth token:', error);
                return null;
            }
        }

        // Set up Outseta event listeners
        function setupOutsetaEventListeners() {
            // Listen for subscription updates
            Outseta.on("subscription.update", async (params) => {
                console.log("Subscription update event:", params);
                await handlePlanChange(params);
            });

            // Listen for subscription reopens
            Outseta.on("subscription.reopen", async (params) => {
                console.log("Subscription reopen event:", params);
                await handlePlanChange(params);
            });
        }

        // Handle plan changes from Outseta events
        async function handlePlanChange(params) {
            try {
                let planName = "Free Trial";

                if (params) {
                    if (params.Plan && params.Plan.Name) {
                        planName = params.Plan.Name;
                    } else if (params.plan && params.plan.name) {
                        planName = params.plan.name;
                    } else if (params.subscription) {
                        if (params.subscription.Plan && params.subscription.Plan.Name) {
                            planName = params.subscription.Plan.Name;
                        } else if (params.subscription.plan && params.subscription.plan.name) {
                            planName = params.subscription.plan.name;
                        }
                    }
                }

                console.log(`Plan change detected: ${planName}`);
                
                // Update plan via API
                await updateUserPlan(planName);
                
                // Refresh usage data
                await loadUsageData();

            } catch (error) {
                console.error('Error handling plan change:', error);
            }
        }

        // Update user plan via API
        async function updateUserPlan(planName) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/update-plan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: currentUser.Email,
                        planName: planName,
                        webhookSecret: 'aquamark-secure-protection-string-101813'
                    })
                });

                if (!response.ok) {
                    throw new Error('Plan update failed');
                }

                console.log('Plan updated successfully');
            } catch (error) {
                console.error('Error updating plan:', error);
            }
        }

        // Display usage data in the UI
        function displayUsageData(userData) {
            const usageStatsElement = document.getElementById('usage-stats');

            if (userData) {
                const usagePercentage = Math.min(100, ((userData.pages_used || 0) / (userData.page_credits || 100)) * 100);

                usageStatsElement.innerHTML = `
                    <div class="usage-stats-container">
                        <div class="usage-stat">
                            <span class="usage-label">Plan:</span>
                            <span class="usage-value">${userData.plan_name || 'Free Trial'}</span>
                        </div>
                        <div class="usage-stat">
                            <span class="usage-label">Pages Used:</span>
                            <span class="usage-value">${userData.pages_used || 0}</span>
                        </div>
                        <div class="usage-stat">
                            <span class="usage-label">Pages Remaining:</span>
                            <span class="usage-value">${userData.pages_remaining || 100}</span>
                        </div>
                        <div class="usage-stat">
                            <span class="usage-label">Total Credits:</span>
                            <span class="usage-value">${userData.page_credits || 100}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${usagePercentage}%;"></div>
                        </div>
                    </div>
                `;
            } else {
                usageStatsElement.innerHTML = '<p>No usage data available yet.</p>';
            }
        }

        // Handle logout redirection
        if (window.location.hash === '#o-logout-link') {
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>
