<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Aquamark Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"/>
  <link rel="icon" href="/logo-icon-black-blue.jpg" type="image/jpg" />

  <style>
    /* Your CSS styles */
  </style>

  <!-- Correct CDN Script for Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Outseta Config -->
  <script>
    const accessToken = new URLSearchParams(window.location.search).get("access_token");

    if (accessToken) {
      localStorage.setItem("aquamark_access_token", accessToken);
    }

    var o_options = {
      domain: "aquamark.outseta.com",
      auth: {
        authenticationCallbackUrl: window.location.origin + "/dashboard.html",
        registrationConfirmationUrl: window.location.origin + "/dashboard.html"
      }
    };
  </script>
  <<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

</head>

<body>

  <script>
    if (window.location.hash === '#o-logout-link') {
      window.location.href = '/login.html';
    }

    // Supabase URL and anon key (for tracking usage, not authentication)
    const SUPABASE_URL = 'https://dvzmnikrvkvgragzhrof.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2em1uaWtydmt2Z3JhZ3pocm9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5Njg5NzUsImV4cCI6MjA1OTU0NDk3NX0.FaHsjIRNlgf6YWbe5foz0kJFtCO4FuVFo7KVcfhKPEk';

    // Initialize Supabase client
    const supabase = createClient('https://dvzmnikrvkvgragzhrof.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2em1uaWtydmt2Z3JhZ3pocm9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5Njg5NzUsImV4cCI6MjA1OTU0NDk3NX0.FaHsjIRNlgf6YWbe5foz0kJFtCO4FuVFo7KVcfhKPEk');

    // Check if the user is logged in via Outseta (authenticated)
    window.addEventListener('load', async () => {
      // Check if the Outseta user is authenticated
      if (Outseta.nocode.user) {
        const email = Outseta.nocode.user.email;

        // Check if the Supabase row exists for this user (track page usage)
        const { data, error } = await supabase
          .from('usage')
          .select('*')
          .eq('user_email', email)
          .single();

        if (error) {
          console.error('Error querying Supabase:', error);
        }

        if (!data) {
          // Insert the row if it doesn't exist
          await supabase.from('usage').insert([
            {
              user_email: email,
              month: 'trial',  // Adjust this if needed based on the userâ€™s plan
              pages_used: 0,
              plan_name: 'Free',  // Adjust according to the user's plan
              page_credits: 100,  // Default page credits
              billing_cycle_start: new Date().toISOString(),
            },
          ]);
        }

        // Proceed with the dashboard or any other page functionality
        console.log('User email:', email);
      } else {
        // Handle case if user is not authenticated
        window.location.href = '/login.html';  // Redirect to login page if not logged in
      }
    });
  </script>

  <header class="aqua-header">
    <img src="/logo-full-black-blue.png" alt="Aquamark Logo" class="aqua-logo" />
    <nav class="aqua-nav">
      <a href="/dashboard.html">Dashboard</a>
      <a href="/watermark.html">Watermark</a>
      <a href="https://www.aquamark.io/#o-logout-link">Log Out</a>
    </nav>
  </header>

  <main class="aqua-panel">
    <h1 class="greeting">My Dashboard</h1>
    <div class="aqua-layout">
      <div class="profile-container">
        <div data-o-profile="1" data-mode="embed"></div>
      </div>
    </div>
  </main>

</body>

</html>
