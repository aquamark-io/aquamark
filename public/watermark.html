<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aquamark Watermarking</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="icon" href="/logo-icon-black-blue.jpg" type="image/jpg">
    <style>
        :root {
            --primary-color: #7e57c2;
            --primary-light: #f3e8ff;
            --primary-dark: #4d2c91;
            --accent-color: #007bff;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --text-primary: #1e1e2f;
            --text-secondary: #64748b;
            --bg-color: #f8f9fb;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .aqua-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--primary-light);
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .aqua-logo {
            height: 32px;
        }

        .aqua-nav {
            display: flex;
            align-items: center;
        }

        .aqua-nav a {
            margin-left: 2rem;
            text-decoration: none;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
            position: relative;
        }

        .aqua-nav a:hover {
            color: var(--accent-color);
        }

        .aqua-nav a.active {
            color: var(--accent-color);
        }

        .aqua-nav a.active:after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            height: 3px;
            width: 100%;
            background: var(--accent-color);
            border-radius: 3px;
        }

        /* Main Content */
        .aqua-panel {
            max-width: 800px;
            width: 95%;
            margin: 2rem auto;
            flex: 1;
        }

        h1.page-title {
            font-size: 2rem;
            margin-bottom: 2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Card */
        .aqua-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-header h2::before {
            content: '';
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: var(--accent-color);
            border-radius: 50%;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Instructions */
        .instructions {
            background: var(--primary-light);
            border-left: 5px solid var(--primary-color);
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: var(--radius);
        }

        .instructions ul {
            padding-left: 1.5rem;
            margin-top: 0.75rem;
        }

        .instructions li {
            margin-bottom: 0.5rem;
        }

        .instructions small {
            display: block;
            margin-top: 1rem;
            color: var(--text-secondary);
        }

        /* Upload Group */
        .upload-group {
            margin-bottom: 1.5rem;
        }

        .upload-group h2 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
        }

        input[type="file"] {
            display: block;
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 0.5rem;
            font-family: inherit;
        }

        /* Logo Preview */
        .logo-preview {
            margin-top: 1rem;
            text-align: center;
        }

        .logo-preview img {
            max-height: 125px;
            border-radius: 8px;
            background: white;
            border: 1px solid var(--border-color);
            padding: 4px;
            max-width: 100%;
        }

        /* Button */
        button {
            background: var(--accent-color);
            border: none;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            background: var(--primary-dark);
        }

        /* Status */
        .status {
            margin-top: 1.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Pages Used Counter */
        .pages-counter {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--primary-light);
            border-radius: var(--radius);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
        }

        .counter-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .counter-info h3 {
            font-size: 1rem;
            font-weight: 600;
        }

        .counter-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .counter-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Upgrade Button */
        .upgrade-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .upgrade-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .upgrade-btn-icon {
            font-size: 1.2rem;
        }

        /* Action Row */
        .action-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
        }

        .logo-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Footer */
        .aqua-footer {
            background: var(--primary-light);
            padding: 1.5rem 2rem;
            margin-top: 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-logo {
            height: 24px;
        }

        .footer-nav {
            display: flex;
            gap: 2rem;
        }

        .footer-nav a {
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .footer-nav a:hover {
            color: var(--accent-color);
        }

        .footer-copyright {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Pulse animation for upgrade button */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .action-row {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .aqua-footer {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .footer-nav {
                flex-direction: column;
                gap: 0.5rem;
            }

            .pages-counter {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .logo-actions {
                flex-direction: column;
            }
        }
    </style>

    <!-- Outseta integration -->
    <script>
        var o_options = {
            domain: 'aquamark.outseta.com',
            load: 'auth,customForm,emailList,leadCapture,nocode,profile,support'
        };
    </script>
    <script src="https://cdn.outseta.com/outseta.min.js" data-options="o_options"></script>
</head>

<body>
    <header class="aqua-header">
        <img src="/logo-full-black-blue.png" alt="Aquamark Logo" class="aqua-logo">
        <nav class="aqua-nav">
            <a href="/dashboard.html" id="dashboardLink">Dashboard</a>
            <a href="/watermark.html" class="active">Watermark</a>
            <a href="/file-tracker.html" id="fileTrackerLink">File Tracker</a>
            <a href="https://www.aquamark.io/login.html">Log Out</a>
        </nav>
    </header>

    <main class="aqua-panel">
        <h1 class="page-title">Watermarking Panel</h1>

        <!-- Pages Used Counter -->
        <div class="pages-counter">
            <div class="counter-info">
                <h3>Pages Watermarked</h3>
                <div class="counter-value" id="pagesWatermarked">0</div>
            </div>
            <a href="/dashboard.html" id="upgradePlanLink" class="upgrade-btn">
                <span class="upgrade-btn-icon">‚≠ê</span>
                Upgrade Plan
            </a>
        </div>

        <div class="aqua-card">
            <div class="card-header">
                <h2>How It Works</h2>
            </div>
            <div class="card-body">
                <div class="instructions">
                    <strong>Tips:</strong>
                    <ul>
                        <li>Add logo (transparent PNG for best results, smaller than 1MB)</li>
                        <li>Upload multiple files at once</li>
                        <li>Click "Watermark Now"</li>
                    </ul>
                    <small>We do not store your PDF files. Downloads begin automatically after watermarking is complete.</small>
                </div>

                <div class="upload-group">
                    <h2>Saved Logo</h2>
                    <div class="logo-preview">
                        <img id="logoImg" src="/logo-placeholder.png" alt="Stored Logo" />
                    </div>
                    <div class="logo-actions">
                        <input type="file" id="logoInput" accept="image/jpeg,image/png" />
                        <button onclick="uploadLogo()">Save Logo</button>
                    </div>
                </div>

                <div class="upload-group">
                    <h2>Upload File(s)</h2>
                    <input type="file" id="pdfInput" accept="application/pdf" multiple />
                </div>

                <div class="action-row">
                    <button onclick="processFiles()">Watermark Now</button>
                    <div class="status" id="status"></div>
                </div>
            </div>
        </div>
    </main>

    <footer class="aqua-footer">
        <img src="/logo-full-black-blue.png" alt="Aquamark Logo" class="footer-logo">
        <div class="footer-nav">
            <a href="https://www.aquamark.io/terms.html">Terms of Service</a>
            <a href="https://www.aquamark.io/privacy.html">Privacy Policy</a>
            <a href="mailto:hey@aquamark.io">Contact Us</a>
        </div>
        <div class="footer-copyright">¬© 2025 Aquamark. All rights reserved.</div>
    </footer>

    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://dvzmnikrvkvgragzhrof.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2em1uaWtydmt2Z3JhZ3pocm9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5Njg5NzUsImV4cCI6MjA1OTU0NDk3NX0.FaHsjIRNlgf6YWbe5foz0kJFtCO4FuVFo7KVcfhKPEk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Preserve URL parameters when navigating between pages
        document.addEventListener('DOMContentLoaded', function() {
            // Get current URL parameters
            const urlParams = window.location.search;
            const hashParams = window.location.hash;

            // Update dashboard link with current parameters
            const dashboardLink = document.getElementById('dashboardLink');
            if (dashboardLink) {
                dashboardLink.href = "/dashboard.html" + urlParams + hashParams;
            }

            const fileTrackerLink = document.getElementById('fileTrackerLink');
  if (fileTrackerLink) {
    fileTrackerLink.href = "/file-tracker.html" + urlParams + hashParams;
  }
            // Update upgrade plan link with current parameters
            const upgradePlanLink = document.getElementById('upgradePlanLink');
            if (upgradePlanLink) {
                upgradePlanLink.href = "/dashboard.html" + urlParams + hashParams;
            }

            // Load saved logo if available
            loadSavedLogo();
        });

        // Handle logout redirection
        if (window.location.hash === '#o-logout-link') {
            window.location.href = '/login.html';
        }

        // Pages counter
        let pagesWatermarked = 0;

        // Function to load the saved logo from Supabase
        async function loadSavedLogo() {
            try {
                const profile = await Outseta.getUser();
                if (!profile || !profile.Email) {
                    console.log("Unable to retrieve user email.");
                    return;
                }

                // Get list of files in user's folder to find the latest logo
                const { data: filesList, error: listError } = await supabase.storage
                    .from("logos")
                    .list(profile.Email);
                
                if (listError) {
                    console.error("Error listing logos:", listError);
                    return;
                }
                
                if (!filesList || filesList.length === 0) {
                    console.log("No saved logos found.");
                    return;
                }
                
                // Find the latest logo file (with the highest timestamp)
                const logoFiles = filesList.filter(file => file.name.startsWith('logo-'));
                
                if (logoFiles.length === 0) {
                    // Try fallback to legacy path
                    const { data } = supabase.storage.from("logos").getPublicUrl(`${profile.Email}/logo.png`);
                    
                    if (data && data.publicUrl) {
                        // Store URL in localStorage
                        localStorage.setItem("aquamarkLogo", data.publicUrl);
                        
                        // Add cache busting parameter
                        const cacheBustUrl = data.publicUrl + "?t=" + new Date().getTime();
                        loadLogoImage(cacheBustUrl);
                    }
                    return;
                }
                
                // Sort by timestamp in filename (logo-1234567890.png)
                logoFiles.sort((a, b) => {
                    const timestampA = parseInt(a.name.split('-')[1]) || 0;
                    const timestampB = parseInt(b.name.split('-')[1]) || 0;
                    return timestampB - timestampA;
                });
                
                // Get the latest logo
                const latestLogo = logoFiles[0];
                const logoPath = `${profile.Email}/${latestLogo.name}`;
                const { data } = supabase.storage.from("logos").getPublicUrl(logoPath);
                
                if (data && data.publicUrl) {
                    // Store URL in localStorage
                    localStorage.setItem("aquamarkLogo", data.publicUrl);
                    
                    // Add cache busting parameter
                    const cacheBustUrl = data.publicUrl + "?t=" + new Date().getTime();
                    loadLogoImage(cacheBustUrl);
                }
            } catch (error) {
                console.error("Error loading logo:", error);
            }
        }
        
        // Helper function to load the logo image with error handling
        function loadLogoImage(url) {
            const img = new Image();
            img.onload = function() {
                // Show the logo in the UI only after it's successfully loaded
                document.getElementById("logoImg").src = url;
                console.log("Logo loaded successfully from Supabase");
            };
            img.onerror = function() {
                console.warn("Saved logo could not be loaded, using default");
                // Keep default image if the logo can't be loaded
            };
            img.src = url;
        }

        // Function to upload and save the logo to Supabase
        async function uploadLogo() {
            const fileInput = document.getElementById("logoInput");
            const status = document.getElementById("status");

            if (!fileInput.files[0]) {
                status.textContent = "Please select an image to upload.";
                return;
            }

            status.textContent = "‚è≥ Uploading logo...";

            try {
                const profile = await Outseta.getUser();
                if (!profile || !profile.Email) {
                    status.textContent = "Unable to retrieve user email.";
                    return;
                }

                const file = fileInput.files[0];
                const path = `${profile.Email}/logo.png`;

                // First, normalize the image to ensure it's properly formatted
                const imageBytes = await normalizeImagePreserveAspect(file);
                const blob = new Blob([imageBytes], { type: 'image/png' });
                const normalizedFile = new File([blob], "logo.png", { type: 'image/png' });

                // Generate a unique path name with timestamp to force cache invalidation
                const timestamp = new Date().getTime();
                const uniquePath = `${profile.Email}/logo-${timestamp}.png`;

                // Upload the normalized file to Supabase Storage
                const { error } = await supabase.storage.from("logos").upload(uniquePath, normalizedFile, {
                    upsert: true,
                    contentType: 'image/png'
                });

                if (error) {
                    status.textContent = "‚ùå Logo upload failed.";
                    console.error("Logo upload error:", error);
                    return;
                }

                // Get the public URL for the uploaded file with timestamp
                const { data } = supabase.storage.from("logos").getPublicUrl(uniquePath);

                // Store URL in localStorage for later use
                localStorage.setItem("aquamarkLogo", data.publicUrl);
                
                // Update the image preview with cache-busting
                document.getElementById("logoImg").src = data.publicUrl + "?t=" + timestamp;
                
                console.log("Logo saved successfully to:", data.publicUrl);
                status.textContent = "‚úÖ Logo saved successfully!";

                // Delete previous versions to save storage space
                try {
                    // Get list of files in user's folder
                    const { data: filesList, error: listError } = await supabase.storage
                        .from("logos")
                        .list(profile.Email);
                    
                    if (!listError && filesList) {
                        // Filter out the current file and delete the rest
                        const currentFileName = uniquePath.split('/').pop();
                        const filesToDelete = filesList
                            .filter(file => file.name !== currentFileName && file.name.startsWith('logo-'))
                            .map(file => `${profile.Email}/${file.name}`);
                        
                        if (filesToDelete.length > 0) {
                            // Delete old files
                            await supabase.storage.from("logos").remove(filesToDelete);
                            console.log(`Deleted ${filesToDelete.length} old logo files`);
                        }
                    }
                } catch (cleanupError) {
                    console.warn("Error during old file cleanup:", cleanupError);
                    // Non-critical error, continue anyway
                }
            } catch (error) {
                console.error("Error in uploadLogo:", error);
                status.textContent = "‚ùå An error occurred during logo upload.";
            }
        }

        async function normalizeImagePreserveAspect(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = new Image();
                    img.onload = function () {
                        // Use a higher resolution for logos to preserve quality
                        const maxSize = 250; // Increased from 150 to 250px for better quality
                        let scale = Math.min(maxSize / img.width, maxSize / img.height);
                        
                        // Make sure we get a multiple of 4 for width and height (helps with compression)
                        const width = Math.floor((img.width * scale) / 4) * 4;
                        const height = Math.floor((img.height * scale) / 4) * 4;
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        
                        // Use high-quality canvas rendering
                        const ctx = canvas.getContext('2d', { alpha: true, willReadFrequently: false });
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        
                        // Clear canvas with transparency
                        ctx.clearRect(0, 0, width, height);
                        
                        // Draw with higher quality
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Use high-quality PNG encoding
                        canvas.toBlob((blob) => {
                            const fr = new FileReader();
                            fr.onload = () => resolve(fr.result);
                            fr.readAsArrayBuffer(blob);
                        }, 'image/png'); // Don't compress (removed quality setting for PNG)
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function decryptPDF(file) {
            const formData = new FormData();
            formData.append("file", file);
            const response = await fetch("https://aquamark-decrypt.onrender.com/decrypt", {
                method: "POST",
                body: formData,
            });
            if (!response.ok) throw new Error("Decryption failed");
            return await response.arrayBuffer();
        }

        async function processFiles() {
            const status = document.getElementById("status");
            const pdfInput = document.getElementById("pdfInput");
            const pagesWatermarkedElement = document.getElementById("pagesWatermarked");
            
            // Check if we have a stored logo or a newly uploaded logo
            let logoUrl = localStorage.getItem("aquamarkLogo");
            const logoInput = document.getElementById("logoInput");
            
            if (!logoUrl && !logoInput.files[0]) {
                status.textContent = "Please upload a logo first.";
                return;
            }
            
            if (pdfInput.files.length === 0) {
                status.textContent = "Please upload at least one PDF.";
                return;
            }

            status.textContent = "‚è≥ Processing...";

            // Reset counter for this session
            pagesWatermarked = 0;
            pagesWatermarkedElement.textContent = pagesWatermarked;

            try {
                // Get current user email from Outseta
                const profile = await Outseta.getUser();
                if (!profile || !profile.Email) {
                    throw new Error("Unable to retrieve user profile");
                }

                // Get current usage data
                const { data, error } = await supabase
                    .from('usage')
                    .select('*')
                    .eq('user_email', profile.Email)
                    .single();

                if (error) throw error;
                if (!data) throw new Error("No usage data found for this user");

                // Calculate total pages needed for all PDFs
                const pdfFiles = Array.from(pdfInput.files);
                let totalPagesNeeded = 0;

                for (let file of pdfFiles) {
                    let pdfBytes;
                    try {
                        // Try loading the file normally (unencrypted)
                        const pdfDoc = await PDFLib.PDFDocument.load(await file.arrayBuffer(), {
                            ignoreEncryption: false
                        });
                        pdfBytes = await file.arrayBuffer();
                        totalPagesNeeded += pdfDoc.getPageCount();
                    } catch (err) {
                        // Fallback to Render decryption
                        status.textContent = "üîê Decrypting encrypted file to check page count...";
                        try {
                            pdfBytes = await decryptPDF(file);
                            const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, {
                                ignoreEncryption: true
                            });
                            totalPagesNeeded += pdfDoc.getPageCount();
                        } catch {
                            status.textContent = "‚ùå Could not decrypt one of the uploaded PDFs.";
                            return;
                        }
                    }
                }

                // Check if user has enough credits
                if (data.pages_remaining < totalPagesNeeded) {
                    status.textContent = `‚ùå Not enough page credits. Balance is ${data.pages_remaining}. Please upgrade your plan.`;
                    
                    // Highlight the upgrade button
                    const upgradeBtn = document.getElementById('upgradePlanLink');
                    if (upgradeBtn) {
                        upgradeBtn.style.animation = 'pulse 1.5s infinite';
                        upgradeBtn.style.boxShadow = '0 0 15px var(--primary-color)';
                    }
                    return;
                }

                // Get logo bytes - either from stored logo or newly uploaded logo
                let logoBytes;
                try {
                    if (logoInput.files[0]) {
                        // Use the just-uploaded logo
                        logoBytes = await normalizeImagePreserveAspect(logoInput.files[0]);
                    } else if (logoUrl) {
                        // Use the stored logo with error handling
                        try {
                            const response = await fetch(logoUrl + "?t=" + new Date().getTime());
                            if (!response.ok) {
                                throw new Error(`Failed to fetch logo: ${response.status}`);
                            }
                            logoBytes = await response.arrayBuffer();
                        } catch (fetchError) {
                            console.error("Error fetching stored logo:", fetchError);
                            status.textContent = "‚ùå Couldn't load saved logo. Please upload a new one.";
                            return;
                        }
                    } else {
                        status.textContent = "‚ùå No logo available. Please upload a logo first.";
                        return;
                    }
                    
                    // Verify we have valid image data
                    if (!logoBytes || logoBytes.byteLength === 0) {
                        throw new Error("Invalid logo data");
                    }
                    
                    // Get hologram image for watermarking
const hologramUrl = "/hologram-1.png";
                    let hologramBytes;
                    try {
                        const response = await fetch(hologramUrl);
                        if (!response.ok) {
                            console.warn("Hologram image not found, continuing without it");
                            hologramBytes = null;
                        } else {
                            hologramBytes = await response.arrayBuffer();
                        }
                    } catch (err) {
                        console.warn("Error loading hologram, continuing without it:", err);
                        hologramBytes = null;
                    }

                    for (let file of pdfFiles) {
                        let pdfBytes;
                        try {
                            // Try loading the file normally (unencrypted)
                            const fileBuffer = await file.arrayBuffer();
                            await PDFLib.PDFDocument.load(fileBuffer, {
                                ignoreEncryption: false
                            });
                            pdfBytes = fileBuffer;
                        } catch (err) {
                            console.log("PDF may be encrypted, attempting to decrypt:", err);
                            // Fallback to Render decryption
                            status.textContent = "ü•∑ Decrypting protected file...";
                            try {
                                pdfBytes = await decryptPDF(file);
                            } catch (decryptErr) {
                                console.error("Decryption error:", decryptErr);
                                status.textContent = "‚ùå Could not process PDF. It may be corrupted or password-protected.";
                                return;
                            }
                        }

                        const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, {
                            ignoreEncryption: true
                        });

                        // Embed logo ONCE per document
let embeddedLogo;
try {
    embeddedLogo = await pdfDoc.embedPng(logoBytes);
} catch (pngError) {
    console.warn("PNG embed failed, trying JPG...");
    try {
        embeddedLogo = await pdfDoc.embedJpg(logoBytes);
    } catch (jpgError) {
        console.error("Failed to embed logo:", jpgError);
        status.textContent = "‚ùå Logo format not supported. Try a different file.";
        return;
    }
}

const logoDims = embeddedLogo.scale(0.35);

                        const pages = pdfDoc.getPages();

// Embed tracking pixel on first page only using dummy pixel image
console.log("Pixel embed starting...", file.name);

try {
  const trackingUrl = `https://dvzmnikrvkvgragzhrof.supabase.co/functions/v1/quick-function?code=${profile.Email}&file_name=${encodeURIComponent(file.name)}&nocache=${Date.now()}`;

  const trackingImage = await pdfDoc.embedPng(trackingUrl); // embed *from URL*, not local file

  const firstPage = pages[0];
  firstPage.drawImage(trackingImage, {
    x: 0,
    y: 0,
    width: 1,
    height: 1,
    opacity: 0.01
  });

  console.log("üìå Remote tracking pixel embedded:", trackingUrl);
} catch (err) {
  console.warn("‚ö†Ô∏è Could not embed tracking pixel:", err);
}

                        // Update the counter with the number of pages in this PDF
                        pagesWatermarked += pages.length;
                        pagesWatermarkedElement.textContent = pagesWatermarked;

                        // Update usage in database
                        const updatedPagesUsed = data.pages_used + pages.length;
                        const updatedPagesRemaining = data.page_credits - updatedPagesUsed;

                        const { error: updateError } = await supabase
                            .from('usage')
                            .update({
                                pages_used: updatedPagesUsed,
                                pages_remaining: updatedPagesRemaining
                            })
                            .eq('user_email', profile.Email);

                        if (updateError) throw updateError;
                        console.log(`Updated usage for ${profile.Email}: ${pages.length} pages added`);
  
                        // Embed hologram if available
                        let hologramImage = null;
                        if (hologramBytes) {
                            try {
                                hologramImage = await pdfDoc.embedPng(hologramBytes);
                            } catch (err) {
                                console.warn("Failed to embed hologram, continuing without it:", err);
                            }
                        }

                    // Add watermarks to all pages
                    for (const page of pages) {
                        const { width, height } = page.getSize();

                        // Add repeating logo watermark
                        for (let x = 0; x < width; x += (logoDims.width + 100)) {
                            for (let y = 0; y < height; y += (logoDims.height + 100)) {
                                page.drawImage(embeddedLogo, {
                                    x,
                                    y,
                                    width: logoDims.width,
                                    height: logoDims.height,
                                    opacity: 0.15,
                                    rotate: PDFLib.degrees(45)
                                });
                            }
                        }

                        // Add hologram watermark if available
                        if (hologramImage) {
                            const hologramWidth = 45;
                            const hologramHeight = 45;
                            
                            try {
                                page.drawImage(hologramImage, {
                                    x: width - hologramWidth - 10,
                                    y: height - hologramHeight - 10,
                                    width: hologramWidth,
                                    height: hologramHeight,
                                    opacity: 0.7
                                });
                            } catch (err) {
                                console.warn("Couldn't draw hologram on page, continuing without it:", err);
                            }
                        }
                    }

                    // Modified approach to maintain original structure for OCR compatibility
                    // Apply targeted PDF optimization for smaller file size
                    const pdfOpts = {
  // Core compression options
  useObjectStreams: true,
  compressContentStreams: true,
  
  // Preserve document structure for OCR compatibility
  preservePDFFormFields: true
};
                    
                    // Use original document to maintain structure
                    try {
                        const finalBytes = await pdfDoc.save(pdfOpts);
                        const blob = new Blob([finalBytes], { type: 'application/pdf' });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = `${file.name.replace(".pdf", "")}-protected.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        // Release object URL to prevent memory leaks
                        setTimeout(() => URL.revokeObjectURL(a.href), 100);
                    } catch (saveErr) {
                        console.error("Error saving PDF:", saveErr);
                        status.textContent = `‚ùå Error saving ${file.name}: ${saveErr.message}`;
                        return;
                    }
                }

                status.textContent = "‚úÖ Done. Files downloaded.";
            } catch (err) {
                console.error("Error processing files:", err);
                status.textContent = `‚ùå An error occurred: ${err.message}. Please try again.`;
            }
                } catch (logoErr) {
                    console.error("Logo processing error:", logoErr);
                    status.textContent = `‚ùå Logo error: ${logoErr.message}. Please try a different image.`;
                }
        }
    </script>
</body>
</html>

