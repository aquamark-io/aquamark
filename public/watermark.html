<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aquamark Watermarking</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="https://cdn.outseta.com/outseta.min.js" defer></script>
</head>
<body>
  <header>
    <div class="container header">
      <img src="/logo.png" alt="Aquamark Logo" class="logo" />
      <h1>Watermark Your PDFs</h1>
    </div>
  </header>

  <main class="container">
    <!-- Stored Logo -->
    <section class="card">
      <h2>Stored Logo</h2>
      <img id="stored-logo" src="" alt="Stored logo preview" style="max-height: 100px; display: none;" />
      <p id="logo-status">Loading stored logo...</p>
    </section>

    <!-- Upload PDFs -->
    <section class="card">
      <h2>Upload PDFs</h2>
      <input type="file" id="pdf-input" multiple accept="application/pdf" />
      <button id="start-button">Start Watermarking</button>
      <p id="status"></p>
    </section>

    <!-- Output download links -->
    <section class="card">
      <h2>Downloads</h2>
      <ul id="download-list"></ul>
    </section>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      Outseta.init({ domain: "aquamark.outseta.com", loadProfile: true });

      Outseta.on("userLoaded", async (user) => {
        const plan = user.account.plan.name;
        const signupDate = new Date(user.account.created);
        const now = new Date();
        const daysSinceSignup = (now - signupDate) / (1000 * 60 * 60 * 24);

        // Load stored logo
        try {
          const token = Outseta.getAccessToken();
          const logoRes = await fetch("https://aquamark-api.onrender.com/api/logo", {
            headers: { Authorization: `Bearer ${token}` }
          });
          const logoData = await logoRes.json();

          if (logoData.logoUrl) {
            const logoImg = document.getElementById("stored-logo");
            logoImg.src = logoData.logoUrl;
            logoImg.style.display = "block";
            document.getElementById("logo-status").textContent = "";
          } else {
            document.getElementById("logo-status").textContent = "No logo found. Please upload one on your dashboard.";
          }
        } catch (e) {
          document.getElementById("logo-status").textContent = "Failed to load logo.";
        }

        // Handle watermarking
        const button = document.getElementById("start-button");
        button.addEventListener("click", async () => {
          if (plan === "Free Trial" && daysSinceSignup > 7) {
            alert("Your free trial has expired. Please upgrade to continue using watermarking.");
            return;
          }

          const files = document.getElementById("pdf-input").files;
          if (!files.length) {
            alert("Please upload at least one PDF.");
            return;
          }

          document.getElementById("status").textContent = `Processing ${files.length} file(s)...`;
          const formData = new FormData();
          for (const file of files) {
            formData.append("pdfs", file);
          }

          try {
            const token = Outseta.getAccessToken();
            const response = await fetch("https://aquamark-api.onrender.com/api/watermark", {
              method: "POST",
              headers: { Authorization: `Bearer ${token}` },
              body: formData
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error || "Unknown error");

            document.getElementById("status").textContent = result.message;
            const downloadList = document.getElementById("download-list");
            downloadList.innerHTML = "";

            result.files.forEach(file => {
              const link = document.createElement("a");
              link.href = `data:application/pdf;base64,${file.data}`;
              link.download = file.fileName;
              link.textContent = `Download ${file.fileName}`;
              link.style.display = "block";
              downloadList.appendChild(link);
            });
          } catch (err) {
            console.error(err);
            document.getElementById("status").textContent = "Error: " + err.message;
          }
        });
      });
    });
  </script>
</body>
</html>
