<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aquamark Watermarking</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
  <link rel="icon" href="/logo-icon-black-blue.jpg" type="image/jpg">

  <style>
    :root {
      --primary-color: #7e57c2;
      --primary-light: #f3e8ff;
      --primary-dark: #4d2c91;
      --accent-color: #007bff;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --text-primary: #1e1e2f;
      --text-secondary: #64748b;
      --bg-color: #f8f9fb;
      --card-bg: #ffffff;
      --border-color: #e2e8f0;
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --radius: 12px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-color);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .aqua-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: var(--primary-light);
      box-shadow: var(--shadow-md);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .aqua-logo { height: 32px; }

    .aqua-nav {
      display: flex;
      align-items: center;
    }

    .aqua-nav a {
      margin-left: 2rem;
      text-decoration: none;
      font-weight: 500;
      color: var(--text-primary);
      position: relative;
    }

    .aqua-nav a:hover,
    .aqua-nav a.active {
      color: var(--accent-color);
    }

    .aqua-panel {
      padding: 2rem;
      flex: 1;
    }

    .page-title {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
    }

    .pages-counter {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      padding: 1rem 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
      margin-bottom: 2rem;
    }

    .counter-info h3 {
      font-size: 1rem;
      color: var(--text-secondary);
    }

    .counter-value {
      font-size: 2rem;
      font-weight: 600;
    }

    .upgrade-btn {
      background: var(--accent-color);
      color: white;
      padding: 0.6rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .aqua-card {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
    }

    .card-header h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .instructions {
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
      color: var(--text-secondary);
    }

    .upload-group {
      margin-bottom: 2rem;
    }

    .logo-preview img {
      max-height: 100px;
      margin-bottom: 1rem;
    }

    .logo-actions {
      display: flex;
      gap: 1rem;
    }

    .action-row {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    button {
      padding: 0.75rem 1.5rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    .status {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .aqua-footer {
      background: #fff;
      padding: 1.5rem 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .footer-logo {
      height: 28px;
    }

    .footer-nav {
      display: flex;
      gap: 1.5rem;
    }

    .footer-nav a {
      font-size: 0.9rem;
      color: var(--text-secondary);
      text-decoration: none;
    }

    .footer-nav a:hover {
      text-decoration: underline;
    }

    .footer-copy {
      font-size: 0.85rem;
      color: var(--text-secondary);
    }
  </style>

  <script>
    var o_options = {
      domain: 'aquamark.outseta.com',
      load: 'auth,nocode'
    };
  </script>
  <script src="https://cdn.outseta.com/outseta.min.js" data-options="o_options"></script>
</head>

<body>
  <header class="aqua-header">
    <img src="/logo-full-black-blue.png" alt="Aquamark Logo" class="aqua-logo" />
    <nav class="aqua-nav">
      <a href="/dashboard.html" id="dashboardLink">Dashboard</a>
      <a href="/watermark.html" class="active">Watermark</a>
      <a href="/file-tracker.html" id="fileTrackerLink">File Tracker</a>
      <a href="https://www.aquamark.io/login.html">Log Out</a>
    </nav>
  </header>

  <main class="aqua-panel">
    <h1 class="page-title">Watermarking Panel</h1>

    <div class="pages-counter">
      <div class="counter-info">
        <h3>Pages Watermarked</h3>
        <div class="counter-value" id="pagesWatermarked">0</div>
      </div>
      <a href="/dashboard.html" id="upgradePlanLink" class="upgrade-btn">
        <span class="upgrade-btn-icon">‚≠ê</span>
        Upgrade Plan
      </a>
    </div>

    <div class="aqua-card">
      <div class="card-header">
        <h2>How It Works</h2>
      </div>
      <div class="card-body">
        <div class="instructions">
          <strong>Tips:</strong>
          <ul>
            <li>Add logo (transparent PNG for best results, under 1MB)</li>
            <li>Upload multiple PDFs</li>
            <li>Click "Watermark Now"</li>
          </ul>
          <small>We don‚Äôt store your PDFs. Downloads begin instantly after watermarking.</small>
        </div>

        <div class="upload-group">
          <h2>Saved Logo</h2>
          <div class="logo-preview">
            <img id="logoImg" src="/logo-placeholder.png" alt="Stored Logo" />
          </div>
          <div class="logo-actions">
            <input type="file" id="logoInput" accept="image/jpeg,image/png" />
            <button onclick="uploadLogo()">Save Logo</button>
          </div>
        </div>

        <div class="upload-group">
          <h2>Upload File(s)</h2>
          <input type="file" id="pdfInput" accept="application/pdf" multiple />
        </div>

        <div class="action-row">
          <button onclick="processFiles()">Watermark Now</button>
          <div class="status" id="status"></div>
        </div>
      </div>
    </div>
  </main>

  <footer class="aqua-footer">
    <img src="/logo-full-black-blue.png" alt="Aquamark Logo" class="footer-logo">
    <div class="footer-nav">
      <a href="https://www.aquamark.io/terms.html">Terms of Service</a>
      <a href="https://www.aquamark.io/privacy.html">Privacy Policy</a>
      <a href="mailto:hey@aquamark.io">Contact Us</a>
    </div>
    <div class="footer-copy">¬© 2025 Aquamark. All rights reserved.</div>
  </footer>

  <script src="https://unpkg.com/pdf-lib@1.18.0/dist/pdf-lib.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = supabase.createClient(
    'https://dvzmnikrvkvgragzhrof.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'
  );

  async function uploadLogo() {
    const logoInput = document.getElementById("logoInput");
    const status = document.getElementById("status");

    if (!logoInput.files.length) {
      status.textContent = "‚ùå Please select a logo image.";
      return;
    }

    const file = logoInput.files[0];
    const { error } = await supabase.storage
      .from("logos")
      .upload("logo.jpg", file, { upsert: true });

    if (error) {
      status.textContent = "‚ùå Upload failed.";
      console.error(error);
    } else {
      document.getElementById("logoImg").src = URL.createObjectURL(file);
      status.textContent = "‚úÖ Logo uploaded successfully.";
    }
  }

  async function decryptPDF(file) {
    const formData = new FormData();
    formData.append("file", file);

    const response = await fetch("https://aquamark-decrypt.onrender.com/decrypt", {

      method: "POST",
      body: formData
    });

    if (!response.ok) throw new Error("Decryption failed");
    return await response.arrayBuffer();
  }

  async function processFiles() {
    const status = document.getElementById("status");
    const pdfInput = document.getElementById("pdfInput");

    if (!pdfInput.files.length) {
      status.textContent = "‚ùå Please upload at least one PDF.";
      return;
    }

    const pdfFiles = Array.from(pdfInput.files);
    let totalPagesNeeded = 0;

    for (let file of pdfFiles) {
      let pdfBytes;
      let pdfDoc;
      try {
        pdfBytes = await file.arrayBuffer();
        pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, { ignoreEncryption: false });
      } catch {
        status.textContent = "üîê Decrypting encrypted file to check page count...";
        try {
          pdfBytes = await decryptPDF(file);
          pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, { ignoreEncryption: true });
        } catch {
          status.textContent = "‚ùå Could not decrypt one of the PDFs.";
          return;
        }
      }
      totalPagesNeeded += pdfDoc.getPageCount();
    }

    status.textContent = "‚è≥ Watermarking...";

    for (let file of pdfFiles) {
      let pdfBytes;
      let pdfDoc;
      try {
        pdfBytes = await file.arrayBuffer();
        pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, { ignoreEncryption: false });
      } catch {
        pdfBytes = await decryptPDF(file);
        pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, { ignoreEncryption: true });
      }

      const logoRes = await fetch("https://dvzmnikrvkvgragzhrof.supabase.co/storage/v1/object/public/logos/logo.jpg");
      const logoBytes = await logoRes.arrayBuffer();
      const embeddedLogo = await pdfDoc.embedPng(logoBytes);

      const pages = pdfDoc.getPages();
      for (const page of pages) {
        const { width, height } = page.getSize();
        page.drawImage(embeddedLogo, {
          x: width / 2 - 100,
          y: height / 2 - 100,
          width: 200,
          height: 200,
          opacity: 0.15,
          rotate: PDFLib.degrees(45)
        });
      }

      // Embed visible tracking hologram
      try {
        const trackingUrl = `https://aquamark.io/hologram.png?t=${Date.now()}-${Math.random()}&code=test@example.com&file_name=${encodeURIComponent(file.name)}`;
        const embeddedHologram = await pdfDoc.embedPngFromUrl(trackingUrl);
        const firstPage = pdfDoc.getPages()[0];
        firstPage.drawImage(embeddedHologram, {
          x: firstPage.getWidth() - 25,
          y: 10,
          width: 20,
          height: 20,
          opacity: 0.3
        });
      } catch (err) {
        console.warn("‚ö†Ô∏è Tracking pixel embed failed:", err);
      }

      const outputBytes = await pdfDoc.save();
      const blob = new Blob([outputBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `watermarked-${file.name}`;
      a.click();
      URL.revokeObjectURL(url);
    }

    status.textContent = "‚úÖ Watermarking complete!";
  }
</script>

</body>
</html>





