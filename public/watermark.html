<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aquamark.io - Watermark Documents</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f8f8ff;
      padding: 40px;
    }
    h1 {
      text-align: center;
    }
    .container {
      background: white;
      max-width: 700px;
      margin: 30px auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    label {
      font-weight: bold;
    }
    input {
      margin-bottom: 15px;
      display: block;
    }
    button {
      background-color: #3b5bff;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Aquamark.io - Watermark Documents</h1>
  <div class="container">
    <label>1. Upload Logo (JPG or PNG)</label>
    <input type="file" id="logo" accept="image/*">

    <label>2. Upload Bank Statements (PDF only, up to 6)</label>
    <input type="file" id="pdfs" accept="application/pdf" multiple>

    <button>3. Watermark Files</button>
    <div id="status">‚ö° Ready to watermark</div>
  </div>

  <script>
    async function createSamplePDFWithImage(imageBytes) {
      const pdfDoc = await PDFLib.PDFDocument.create();
      const page = pdfDoc.addPage([300, 300]);
      const img = await pdfDoc.embedJpg(imageBytes);
      page.drawImage(img, { x: 100, y: 100, width: 100, height: 100 });
      return await pdfDoc.save();
    }

    async function handleWatermarking() {
      const logoInput = document.getElementById('logo');
      const filesInput = document.getElementById('pdfs');
      const status = document.getElementById('status');
      const logoFile = logoInput.files[0];
      const pdfFiles = [...filesInput.files];

      if (!logoFile || pdfFiles.length === 0) {
        alert('Please upload both a logo and at least one PDF.');
        return;
      }

      status.innerText = 'üïê Processing...';

      try {
        const logoBytes = await logoFile.arrayBuffer();
        const logoImg = await PDFLib.PDFDocument.load(await createSamplePDFWithImage(logoBytes));
        const logoEmbed = await logoImg.embedJpg(logoBytes);
        const logoWidth = 100;
        const logoHeight = (logoWidth / logoEmbed.width) * logoEmbed.height;

        for (const file of pdfFiles) {
          const fileBytes = await file.arrayBuffer();
          const pdfDoc = await PDFLib.PDFDocument.load(fileBytes, { ignoreEncryption: true });
          const pages = pdfDoc.getPages();

          for (const page of pages) {
            const { width, height } = page.getSize();
            const cols = Math.floor(width / (logoWidth + 30));
            const rows = Math.floor(height / (logoHeight + 30));

            for (let row = 0; row < rows; row++) {
              for (let col = 0; col < cols; col++) {
                const x = col * (logoWidth + 30);
                const y = height - (row + 1) * (logoHeight + 30);
                page.drawImage(logoEmbed, {
                  x,
                  y,
                  width: logoWidth,
                  height: logoHeight,
                  opacity: 0.2,
                });
              }
            }
          }

          const pdfBytes = await pdfDoc.save();
          window.blob = new Blob([pdfBytes], { type: 'application/pdf' });
          const blobUrl = URL.createObjectURL(window.blob);
          const link = document.createElement('a');
          link.href = blobUrl;
          link.download = `manual-test-${file.name}`;
          link.click();

          status.innerText = '‚úÖ Done. Files downloaded.';
        }
      } catch (err) {
        console.error('‚ùå PDF processing failed:', err);
        status.innerText = '‚ùå Failed to watermark. See console.';
      }
    }

    document.querySelector('button').addEventListener('click', handleWatermarking);
  </script>
</body>
</html>
