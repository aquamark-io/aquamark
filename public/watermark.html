<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aquamark.io - Watermark Documents</title>
  <style>
    body { font-family: sans-serif; background: #f9f9ff; padding: 0; margin: 0; }
    header { background: #ede4ff; padding: 1rem; font-weight: bold; text-align: center; font-size: 1.2rem; }
    main { max-width: 700px; margin: 2rem auto; background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 0 10px rgba(0,0,0,0.06); }
    h2 { margin-top: 1rem; font-size: 1rem; }
    input[type="file"] { margin: 0.5rem 0 1rem; display: block; }
    button { padding: 0.75rem 1.5rem; background: #3f5efb; color: white; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; }
    .status { margin-top: 1rem; color: #444; font-weight: 500; display: flex; align-items: center; gap: 0.5rem; }
    .status.done { color: green; }
    .status.error { color: red; }
  </style>
</head>
<body>
  <header>Aquamark.io - Watermark Documents</header>
  <main>
    <h2>1. Upload Logo (JPG or PNG)</h2>
    <input type="file" id="logoInput" accept="image/*" />

    <h2>2. Upload Bank Statements (PDF only, up to 6)</h2>
    <input type="file" id="pdfInput" accept="application/pdf" multiple />

    <button onclick="processFiles()">3. Watermark Files</button>
    <div id="toast" class="status"></div>
  </main>

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    async function processFiles() {
      const toast = document.getElementById('toast');
      const logoFile = document.getElementById('logoInput').files[0];
      const pdfFiles = document.getElementById('pdfInput').files;

      if (!logoFile || pdfFiles.length === 0) {
        toast.textContent = '❌ Please upload both a logo and PDFs.';
        toast.className = 'status error';
        return;
      }

      toast.textContent = '⏳ Processing...';
      toast.className = 'status';

      const logoBytes = await logoFile.arrayBuffer();
      const logoExt = logoFile.name.endsWith('.png') ? 'png' : 'jpg';

      for (const file of pdfFiles) {
        try {
          const pdfBytes = await file.arrayBuffer();
          const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, { ignoreEncryption: true });
          const image = logoExt === 'png'
            ? await pdfDoc.embedPng(logoBytes)
            : await pdfDoc.embedJpg(logoBytes);

          const pages = pdfDoc.getPages();
          for (const page of pages) {
            const { width, height } = page.getSize();
            const imgW = 60, imgH = 60;
            const gapX = 120, gapY = 100;

            for (let y = 0; y < height; y += gapY) {
              for (let x = 0; x < width; x += gapX) {
                page.drawImage(image, {
                  x: x + 10,
                  y: y + 10,
                  width: imgW,
                  height: imgH,
                  opacity: 0.08,
                  rotate: PDFLib.degrees(-30),
                });
              }
            }
          }

          const finalPdf = await pdfDoc.save();
          if (!finalPdf || finalPdf.byteLength < 100) throw new Error('Corrupt output');

          const blob = new Blob([finalPdf], { type: 'application/pdf' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `watermarked-${file.name}`;
          a.click();
          URL.revokeObjectURL(url);
        } catch (err) {
          console.error(err);
          toast.textContent = '❌ One or more files failed to watermark.';
          toast.className = 'status error';
          return;
        }
      }

      toast.textContent = '✅ Done. Files downloaded';
      toast.className = 'status done';
    }
  </script>
</body>
</html>
