<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Aquamark.io - Watermark Documents</title>
  <script src="https://unpkg.com/pdf-lib"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f8f8ff;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-top: 40px;
      font-size: 24px;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 20px 30px;
      margin-top: 20px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.08);
      max-width: 600px;
      width: 100%;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input[type="file"] {
      margin-top: 4px;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-weight: bold;
      background-color: #3f5efb;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #status {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Aquamark.io - Watermark Documents</h1>
  <div class="container">
    <label>1. Upload Logo (JPG or PNG)</label>
    <input type="file" id="logo" accept="image/jpeg, image/png" />

    <label>2. Upload Bank Statements (PDF only, up to 6)</label>
    <input type="file" id="pdfs" accept="application/pdf" multiple />

    <button onclick="watermarkFiles()">3. Watermark Files</button>

    <div id="status"></div>
  </div>

  <script>
    async function loadImageAsJpgBytes(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = 200;
          canvas.height = 200;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          canvas.toBlob((blob) => {
            const reader = new FileReader();
            reader.onload = () => resolve(new Uint8Array(reader.result));
            reader.readAsArrayBuffer(blob);
          }, "image/jpeg");
        };
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    async function watermarkFiles() {
      const logoInput = document.getElementById("logo");
      const pdfInput = document.getElementById("pdfs");
      const status = document.getElementById("status");

      status.innerText = "Processing... ⏳";

      if (!logoInput.files[0] || !pdfInput.files.length) {
        status.innerText = "Please upload both a logo and PDF files.";
        return;
      }

      let logoBytes;
      try {
        logoBytes = await loadImageAsJpgBytes(logoInput.files[0]);
      } catch (err) {
        console.error("Failed to process logo:", err);
        status.innerText = "❌ Failed to process logo.";
        return;
      }

      for (const pdfFile of pdfInput.files) {
        try {
          const pdfBytes = await pdfFile.arrayBuffer();
          const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes, { ignoreEncryption: true });
          const logoImg = await pdfDoc.embedJpg(logoBytes);

          const pages = pdfDoc.getPages();
          for (const page of pages) {
            const { width, height } = page.getSize();
            const xCount = Math.floor(width / (logoImg.width / 4 + 50));
            const yCount = Math.floor(height / (logoImg.height / 4 + 50));

            for (let i = 0; i < xCount; i++) {
              for (let j = 0; j < yCount; j++) {
                page.drawImage(logoImg, {
                  x: i * (logoImg.width / 4 + 50),
                  y: j * (logoImg.height / 4 + 50),
                  width: logoImg.width / 4,
                  height: logoImg.height / 4,
                  opacity: 0.2,
                  rotate: PDFLib.degrees(45)
                });
              }
            }
          }

          const output = await pdfDoc.save();
          const blob = new Blob([output], { type: "application/pdf" });
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = "watermarked-" + pdfFile.name;
          link.click();
        } catch (err) {
          console.error("PDF processing failed:", err);
          status.innerText = "❌ Failed to watermark. See console.";
          return;
        }
      }

      status.innerText = "✅ Done. Files downloaded.";
    }
  </script>
</body>
</html>
