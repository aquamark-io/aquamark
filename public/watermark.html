<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Watermark Files - Aquamark</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: #fff;
      color: #111;
    }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 32px;
      border-bottom: 1px solid #eee;
    }
    .logo {
      height: 36px;
    }
    nav {
      display: flex;
      gap: 24px;
    }
    nav a {
      text-decoration: none;
      color: #3e5eff;
      font-weight: 600;
      font-size: 14px;
    }
    nav a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <header class="topbar">
    <img src="/logo-full-black-blue.png" alt="Aquamark Logo" class="logo" />
    <nav>
      <a href="/dashboard.html">Dashboard</a>
      <a href="/watermark.html">Watermark</a>
      <a href="/api.html">API</a>
      <a href="/profile.html">Profile</a>
      <a href="https://www.aquamark.io/#o-logout-link">Log Out</a>
    </nav>
  </header>

  <main style="padding: 40px 32px;">
    <h2>Watermark Your Files</h2>
    <div style="display: flex; gap: 40px; flex-wrap: wrap; align-items: flex-start;">
      <!-- Upload Section -->
      <div style="flex: 1; min-width: 280px;">
        <label style="font-weight: 600;">Upload your watermark logo (PNG or JPG):</label><br />
        <input type="file" id="logoInput" accept="image/png, image/jpeg" />
        <button id="changeLogoButton" style="margin-top: 8px;">Change Logo</button>
        <div id="logoPreviewContainer" style="display:none; margin-top: 16px;">
          <p style="font-weight: 600;">Your uploaded logo:</p>
          <img id="logoPreview" src="" alt="Your Logo" style="max-width: 300px; border: 1px solid #eee; padding: 8px;" />
        </div>
      </div>

      <!-- Sample Preview Section -->
      <div style="flex: 1; min-width: 300px;">
        <p style="font-weight: 600; margin-bottom: 8px;">See a sample:</p>
        <div style="position: relative; width: 100%; max-width: 500px; border: 1px solid #ccc;">
          <img id="statementImage" src="/statement.jpg" alt="Sample Statement" style="width: 100%; display: block;" />
          <div id="watermarkOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- âœ… Supabase Logo Upload + Tiled Watermark Overlay -->
  <script type="module">
    import { createClient } from "https://cdn.skypack.dev/@supabase/supabase-js";

    const supabase = createClient(
      "https://dvzmnikrvkvgragzhrof.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR2em1uaWtydmt2Z3JhZ3pocm9mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5Njg5NzUsImV4cCI6MjA1OTU0NDk3NX0.FaHsjIRNlgf6YWbe5foz0kJFtCO4FuVFo7KVcfhKPEk"
    );

    const logoInput = document.getElementById("logoInput");
    const changeLogoButton = document.getElementById("changeLogoButton");
    const previewImage = document.getElementById("logoPreview");
    const previewContainer = document.getElementById("logoPreviewContainer");
    const overlay = document.getElementById("watermarkOverlay");

    function applyWatermark(url) {
      overlay.style.backgroundImage = `url('${url}')`;
      overlay.style.backgroundRepeat = "repeat";
      overlay.style.backgroundSize = "120px auto";
      overlay.style.opacity = "0.08";
      overlay.style.transform = "rotate(-25deg)";
      overlay.style.backgroundPosition = "0 0";
    }

    const storedLogo = localStorage.getItem("aquamark_logo_url");
    if (storedLogo) {
      previewImage.src = storedLogo;
      previewContainer.style.display = "block";
      applyWatermark(storedLogo);
    }

    changeLogoButton.addEventListener("click", async () => {
      const file = logoInput.files[0];
      if (!file) return;

      const extension = file.name.split(".").pop().toLowerCase();
      const filePath = `logo.${extension}`;

      await supabase.storage.from("logos").remove([filePath]);

      const { error: uploadError } = await supabase.storage
        .from("logos")
        .upload(filePath, file, {
          upsert: true,
          contentType: file.type,
        });

      if (uploadError) {
        alert("Upload failed: " + uploadError.message);
        return;
      }

      const { data: publicData } = supabase.storage.from("logos").getPublicUrl(filePath);
      const url = publicData.publicUrl;

      localStorage.setItem("aquamark_logo_url", url);
      previewImage.src = url;
      previewContainer.style.display = "block";
      applyWatermark(url);
    });
  </script>
</body>
</html>
